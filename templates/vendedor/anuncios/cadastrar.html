{% extends "base_privada.html" %}
{% from "macros/form_fields.html" import field with context %}

{% block titulo %}Cadastrar Anuncio{% endblock %}

{% block content %}
<div class="row">
    <div class="col-lg-10 mx-auto">
        <!-- Cabecalho -->
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2><i class="bi bi-plus-circle"></i> Cadastrar Anuncio</h2>
            <a href="/vendedor/anuncios" class="btn btn-outline-secondary">
                <i class="bi bi-arrow-left"></i> Voltar
            </a>
        </div>

        <!-- Formulario de Cadastro -->
        <div class="card shadow-sm">
            <form action="/vendedor/anuncios/cadastrar" method="post" id="form-anuncio">
                {{ csrf_input() }}
                <div class="card-body p-4">
                    <div class="row">
                        <div class="col-12">
                            {% include "components/alerta_erro.html" %}
                        </div>

                        <!-- Foto do Anuncio -->
                        <div class="col-md-4 mb-4">
                            <label class="form-label">Foto do Produto</label>
                            <div class="text-center">
                                <div class="mb-3 position-relative d-inline-block">
                                    <img src="/static/img/produto-sem-foto.jpg" alt="Foto do produto"
                                         id="preview-foto" class="rounded border"
                                         style="width: 200px; height: 200px; object-fit: cover; cursor: pointer;"
                                         title="Clique para selecionar uma foto">
                                    <div class="position-absolute bottom-0 end-0 p-2">
                                        <span class="badge bg-primary">
                                            <i class="bi bi-camera"></i>
                                        </span>
                                    </div>
                                </div>
                                <input type="file" id="input-foto" accept=".jpg,.jpeg,.png,.gif,.webp" class="d-none">
                                <input type="hidden" name="foto_base64" id="foto-base64">
                                <div class="form-text">
                                    Clique na imagem para selecionar.<br>
                                    Formatos: JPG, PNG, GIF, WEBP. Max: 5MB
                                </div>
                            </div>
                        </div>

                        <!-- Dados do Anuncio -->
                        <div class="col-md-8">
                            <div class="row">
                                <div class="col-12 mb-3">
                                    {{ field(name='nome', label='Nome do Produto', type='text', required=true,
                                    value=dados.nome, placeholder='Ex: Smartphone Samsung Galaxy',
                                    attributes={'minlength': 3, 'maxlength': 100}) }}
                                </div>

                                <div class="col-12 mb-3">
                                    {{ field(name='descricao', label='Descricao', type='textarea', required=true,
                                    value=dados.descricao, placeholder='Descreva o produto em detalhes...',
                                    attributes={'rows': 4, 'minlength': 10, 'maxlength': 1000}) }}
                                </div>

                                <div class="col-md-6 mb-3">
                                    <label for="id_categoria" class="form-label">Categoria <span class="text-danger">*</span></label>
                                    <select name="id_categoria" id="id_categoria" class="form-select" required>
                                        <option value="">Selecione uma categoria...</option>
                                        {% for categoria in categorias %}
                                        <option value="{{ categoria.id }}" {% if dados.id_categoria == categoria.id %}selected{% endif %}>
                                            {{ categoria.nome }}
                                        </option>
                                        {% endfor %}
                                    </select>
                                    {% if erros and erros.id_categoria %}
                                    <div class="invalid-feedback d-block">{{ erros.id_categoria }}</div>
                                    {% endif %}
                                </div>

                                <div class="col-md-6 mb-3">
                                    {{ field(name='peso', label='Peso (kg)', type='number', required=true,
                                    value=dados.peso, placeholder='0.5',
                                    attributes={'step': '0.01', 'min': '0.01', 'max': '1000'}) }}
                                </div>

                                <div class="col-md-6 mb-3">
                                    {{ field(name='preco', label='Preco (R$)', type='number', required=true,
                                    value=dados.preco, placeholder='99.90',
                                    attributes={'step': '0.01', 'min': '0.01', 'max': '999999.99'}) }}
                                </div>

                                <div class="col-md-6 mb-3">
                                    {{ field(name='estoque', label='Quantidade em Estoque', type='number', required=true,
                                    value=dados.estoque, placeholder='10',
                                    attributes={'min': '0', 'max': '99999'}) }}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="card-footer p-4">
                    <div class="d-flex gap-3">
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-check-circle"></i> Cadastrar Anuncio
                        </button>
                        <a href="/vendedor/anuncios" class="btn btn-outline-secondary">
                            Cancelar
                        </a>
                    </div>
                </div>
            </form>
        </div>

        <!-- Dica -->
        <div class="alert alert-info mt-4" role="alert">
            <i class="bi bi-lightbulb"></i>
            <strong>Dica:</strong> Adicione uma foto de qualidade e uma descricao detalhada para atrair mais compradores!
        </div>
    </div>
</div>

<!-- Modal de Crop de Foto -->
{% set modal_id = "modalFotoAnuncio" %}
{% set modal_title = "Foto do Produto" %}
{% set form_action = "" %}
{% set aspect_ratio = 1.0 %}
{% set max_file_size_mb = 5 %}
{% set show_upload_section = false %}
{% include 'components/modal_corte_imagem.html' %}
{% endblock %}

{% block scripts %}
<!-- Cropper.js CSS e JS -->
<link href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.1/cropper.min.css" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.1/cropper.min.js"></script>

<!-- Componente de Corte de Imagem -->
<script src="/static/js/cortador-imagem.js"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const inputFoto = document.getElementById('input-foto');
    const previewFoto = document.getElementById('preview-foto');
    const fotoBase64 = document.getElementById('foto-base64');
    const modal = document.getElementById('modalFotoAnuncio');
    const cropperImage = document.getElementById('cropper-image-modalFotoAnuncio');
    const cropperContainer = document.getElementById('cropper-container-modalFotoAnuncio');
    const previewCrop = document.getElementById('preview-modalFotoAnuncio');
    const btnSubmit = document.getElementById('btn-submit-modalFotoAnuncio');
    const fotoBase64Modal = document.getElementById('foto-base64-modalFotoAnuncio');

    let cropper = null;

    // Clicar na imagem abre o seletor de arquivo
    previewFoto.addEventListener('click', function() {
        inputFoto.click();
    });

    // Quando seleciona um arquivo
    inputFoto.addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (!file) return;

        // Validar tamanho
        if (file.size > 5 * 1024 * 1024) {
            alert('Arquivo muito grande. Tamanho maximo: 5MB');
            return;
        }

        // Validar tipo
        if (!file.type.match(/^image\/(jpeg|jpg|png|gif|webp)$/)) {
            alert('Formato invalido. Use: JPG, PNG, GIF ou WEBP');
            return;
        }

        const reader = new FileReader();
        reader.onload = function(event) {
            // Mostrar no modal
            cropperImage.src = event.target.result;
            cropperContainer.classList.remove('d-none');

            // Abrir modal
            const bsModal = new bootstrap.Modal(modal);
            bsModal.show();

            // Inicializar cropper quando modal abrir
            modal.addEventListener('shown.bs.modal', function initCropper() {
                if (cropper) {
                    cropper.destroy();
                }
                cropper = new Cropper(cropperImage, {
                    aspectRatio: 1,
                    viewMode: 1,
                    dragMode: 'move',
                    autoCropArea: 0.9,
                    restore: false,
                    guides: true,
                    center: true,
                    highlight: false,
                    cropBoxMovable: true,
                    cropBoxResizable: true,
                    toggleDragModeOnDblclick: false,
                    crop: function() {
                        // Atualizar preview
                        const canvas = cropper.getCroppedCanvas({
                            width: 400,
                            height: 400
                        });
                        if (canvas) {
                            previewCrop.src = canvas.toDataURL('image/jpeg', 0.9);
                            btnSubmit.disabled = false;
                        }
                    }
                });
                modal.removeEventListener('shown.bs.modal', initCropper);
            }, {once: true});
        };
        reader.readAsDataURL(file);
    });

    // Salvar foto cropada
    btnSubmit.addEventListener('click', function(e) {
        e.preventDefault();
        if (!cropper) return;

        const canvas = cropper.getCroppedCanvas({
            width: 800,
            height: 800
        });

        if (canvas) {
            const base64 = canvas.toDataURL('image/jpeg', 0.9);
            fotoBase64.value = base64;
            previewFoto.src = base64;

            // Fechar modal
            const bsModal = bootstrap.Modal.getInstance(modal);
            bsModal.hide();

            // Destruir cropper
            if (cropper) {
                cropper.destroy();
                cropper = null;
            }
        }
    });

    // Limpar ao fechar modal
    modal.addEventListener('hidden.bs.modal', function() {
        if (cropper) {
            cropper.destroy();
            cropper = null;
        }
        inputFoto.value = '';
    });
});
</script>
{% endblock %}
