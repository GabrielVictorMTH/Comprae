{% extends "base_publica.html" %}

{% block titulo %}Anúncios{% endblock %}

{% block content %}
<div class="py-2">
    <!-- Cabeçalho com gradiente -->
    <div class="hero-gradient text-white rounded-4 shadow-lg p-4 mb-4">
        <div class="row align-items-center position-relative" style="z-index: 1;">
            <div class="col-lg-8">
                <h1 class="fw-bold mb-2">
                    <i class="bi bi-shop me-2"></i>Anúncios
                </h1>
                <p class="mb-0 opacity-90">Encontre os melhores produtos dos nossos vendedores</p>
            </div>
            <div class="col-lg-4 text-lg-end mt-3 mt-lg-0">
                <span class="badge bg-white bg-opacity-25 text-white px-3 py-2">
                    <i class="bi bi-box-seam me-1"></i>
                    {{ total_anuncios }} produto{% if total_anuncios != 1 %}s{% endif %}
                </span>
            </div>
        </div>
    </div>

    <!-- Filtros Modernizados -->
    <div class="card feature-card shadow-sm mb-4">
        <div class="card-body p-4">
            <form action="/anuncios" method="get">
                <div class="row g-3 align-items-end">
                    <div class="col-md-4">
                        <label for="busca" class="form-label fw-semibold">
                            <i class="bi bi-search me-1 text-primary"></i>Buscar
                        </label>
                        <input type="text" class="form-control form-control-lg" id="busca" name="busca"
                               placeholder="O que você procura?" value="{{ busca }}">
                    </div>
                    <div class="col-md-3">
                        <label for="categoria" class="form-label fw-semibold">
                            <i class="bi bi-tag me-1 text-primary"></i>Categoria
                        </label>
                        <select class="form-select form-select-lg" id="categoria" name="categoria">
                            <option value="">Todas as categorias</option>
                            {% for cat in categorias %}
                            <option value="{{ cat.id }}" {% if categoria_selecionada == cat.id %}selected{% endif %}>
                                {{ cat.nome }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label for="ordenar" class="form-label fw-semibold">
                            <i class="bi bi-sort-down me-1 text-primary"></i>Ordenar por
                        </label>
                        <select class="form-select form-select-lg" id="ordenar" name="ordenar">
                            <option value="">Mais recentes</option>
                            <option value="preco_asc" {% if ordenacao_selecionada == 'preco_asc' %}selected{% endif %}>
                                Menor preco
                            </option>
                            <option value="preco_desc" {% if ordenacao_selecionada == 'preco_desc' %}selected{% endif %}>
                                Maior preco
                            </option>
                            <option value="data_asc" {% if ordenacao_selecionada == 'data_asc' %}selected{% endif %}>
                                Mais antigos
                            </option>
                            <option value="data_desc" {% if ordenacao_selecionada == 'data_desc' %}selected{% endif %}>
                                Mais recentes
                            </option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <button type="submit" class="btn btn-gradient-primary btn-lg w-100">
                            <i class="bi bi-funnel me-2"></i>Filtrar
                        </button>
                    </div>
                </div>
                {% if busca or categoria_selecionada %}
                <div class="mt-3 pt-3 border-top">
                    <div class="d-flex align-items-center gap-2 flex-wrap">
                        <span class="text-muted">Filtros ativos:</span>
                        {% if busca %}
                        <span class="badge bg-primary bg-opacity-10 text-primary px-3 py-2">
                            <i class="bi bi-search me-1"></i>"{{ busca }}"
                        </span>
                        {% endif %}
                        {% if categoria_selecionada %}
                        <span class="badge bg-success bg-opacity-10 text-success px-3 py-2">
                            <i class="bi bi-tag me-1"></i>{{ categorias|selectattr('id', 'equalto', categoria_selecionada)|map(attribute='nome')|first }}
                        </span>
                        {% endif %}
                        <a href="/anuncios" class="btn btn-outline-secondary btn-sm ms-auto">
                            <i class="bi bi-x-circle me-1"></i>Limpar filtros
                        </a>
                    </div>
                </div>
                {% endif %}
            </form>
        </div>
    </div>

    <!-- Resultados -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <p class="text-muted mb-0">
            {% if total_anuncios > 0 %}
            <i class="bi bi-grid me-1"></i>
            Mostrando <strong>{{ anuncios|length }}</strong> de <strong>{{ total_anuncios }}</strong> anúncio{% if total_anuncios != 1 %}s{% endif %}
            {% else %}
            Nenhum anúncio encontrado
            {% endif %}
        </p>
    </div>

    {% if anuncios %}
    <!-- Grid de Anúncios -->
    <div class="row row-cols-1 row-cols-sm-2 row-cols-md-3 row-cols-lg-4 g-4 mb-4">
        {% for anuncio in anuncios %}
        <div class="col animate-fade-in-up stagger-{{ loop.index % 4 + 1 }}">
            {% include "components/card_anuncio.html" %}
        </div>
        {% endfor %}
    </div>

    <!-- Paginação Modernizada -->
    {% if total_paginas > 1 %}
    <nav aria-label="Navegação de páginas">
        <ul class="pagination justify-content-center gap-1">
            <!-- Anterior -->
            <li class="page-item {% if pagina_atual <= 1 %}disabled{% endif %}">
                <a class="page-link rounded-3 px-3" href="/anuncios?pagina={{ pagina_atual - 1 }}{% if busca %}&busca={{ busca }}{% endif %}{% if categoria_selecionada %}&categoria={{ categoria_selecionada }}{% endif %}" {% if ordenacao_selecionada %}&ordenar={{ ordenacao_selecionada }}{% endif %}>
                    <i class="bi bi-chevron-left"></i>
                </a>
            </li>

            <!-- Números das páginas -->
            {% set inicio = [1, pagina_atual - 2]|max %}
            {% set fim = [total_paginas, pagina_atual + 2]|min %}

            {% if inicio > 1 %}
            <li class="page-item">
                <a class="page-link rounded-3" href="/anuncios?pagina=1{% if busca %}&busca={{ busca }}{% endif %}{% if categoria_selecionada %}&categoria={{ categoria_selecionada }}{% endif %}" {% if ordenacao_selecionada %}&ordenar={{ ordenacao_selecionada }}{% endif %}>1</a>
            </li>
            {% if inicio > 2 %}
            <li class="page-item disabled"><span class="page-link rounded-3 border-0">...</span></li>
            {% endif %}
            {% endif %}

            {% for p in range(inicio, fim + 1) %}
            <li class="page-item {% if p == pagina_atual %}active{% endif %}">
                <a class="page-link rounded-3 {% if p == pagina_atual %}btn-gradient-primary border-0{% endif %}"
                   href="/anuncios?pagina={{ p }}{% if busca %}&busca={{ busca }}{% endif %}{% if categoria_selecionada %}&categoria={{ categoria_selecionada }}{% endif %}" {% if ordenacao_selecionada %}&ordenar={{ ordenacao_selecionada }}{% endif %}>{{ p }}</a>
            </li>
            {% endfor %}

            {% if fim < total_paginas %}
            {% if fim < total_paginas - 1 %}
            <li class="page-item disabled"><span class="page-link rounded-3 border-0">...</span></li>
            {% endif %}
            <li class="page-item">
                <a class="page-link rounded-3" href="/anuncios?pagina={{ total_paginas }}{% if busca %}&busca={{ busca }}{% endif %}{% if categoria_selecionada %}&categoria={{ categoria_selecionada }}{% endif %}" {% if ordenacao_selecionada %}&ordenar={{ ordenacao_selecionada }}{% endif %}>{{ total_paginas }}</a>
            </li>
            {% endif %}

            <!-- Próximo -->
            <li class="page-item {% if pagina_atual >= total_paginas %}disabled{% endif %}">
                <a class="page-link rounded-3 px-3" href="/anuncios?pagina={{ pagina_atual + 1 }}{% if busca %}&busca={{ busca }}{% endif %}{% if categoria_selecionada %}&categoria={{ categoria_selecionada }}{% endif %}" {% if ordenacao_selecionada %}&ordenar={{ ordenacao_selecionada }}{% endif %}>
                    <i class="bi bi-chevron-right"></i>
                </a>
            </li>
        </ul>
    </nav>
    {% endif %}

    {% else %}
    <!-- Estado Vazio Modernizado -->
    <div class="card feature-card shadow-sm">
        <div class="card-body text-center py-5">
            <div class="animate-float mb-4">
                <i class="bi bi-box-seam" style="font-size: 5rem; color: #667eea; opacity: 0.5;"></i>
            </div>
            <h4 class="fw-bold mb-2">Nenhum anúncio encontrado</h4>
            <p class="text-muted mb-4">
                {% if busca or categoria_selecionada %}
                Tente ajustar os filtros de busca para encontrar o que procura.
                {% else %}
                Ainda não há anúncios cadastrados na plataforma.
                {% endif %}
            </p>
            {% if busca or categoria_selecionada %}
            <a href="/anuncios" class="btn btn-gradient-primary px-4">
                <i class="bi bi-arrow-counterclockwise me-2"></i>Ver todos os anúncios
            </a>
            {% else %}
            <a href="/cadastrar" class="btn btn-gradient-primary px-4">
                <i class="bi bi-plus-circle me-2"></i>Seja o primeiro a anunciar
            </a>
            {% endif %}
        </div>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block scripts %}
<script>
// Remove o campo categoria do formulário quando vazio para evitar erro 422
document.querySelector('form[action="/anuncios"]').addEventListener('submit', function(e) {
    const categoria = document.getElementById('categoria');
    if (categoria.value === '') {
        categoria.removeAttribute('name');
    }
    const ordenar = document.getElementById('ordenar');
    if (ordenar.value === '') {
        ordenar.removeAttribute('name');
    }
});
</script>
{% endblock %}
